set -x
set -e
# sudo add-apt-repository -y ppa:openjdk-r/ppa
sudo apt-get install aptitude

if [ ! -z "$SERVER" ]; then
   # Install etcher
   echo "deb https://deb.etcher.io stable etcher" | sudo tee /etc/apt/sources.list.d/balena-etcher.list
fi
sudo add-apt-repository -y ppa:apt-fast/stable
sudo apt-get update
sudo apt-get -y install apt-fast
sudo apt-get install -y aptitude
sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
Types: deb
URIs: https://download.docker.com/linux/ubuntu
Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
Components: stable
Signed-By: /etc/apt/keyrings/docker.asc
EOF

sudo apt-fast update && sudo apt-get -y upgrade
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# Install packages from mypackages with graceful fallback
echo "Checking package availability from mypackages..."
AVAILABLE_PACKAGES=""
SKIPPED_PACKAGES=""

while IFS= read -r package; do
  # Skip empty lines and comments
  [[ -z "$package" || "$package" =~ ^[[:space:]]*# ]] && continue
  
  # Check if package is available in apt cache
  if apt-cache show "$package" > /dev/null 2>&1; then
    AVAILABLE_PACKAGES="$AVAILABLE_PACKAGES $package"
  else
    echo "Warning: Package $package not found in repositories, skipping..."
    SKIPPED_PACKAGES="$SKIPPED_PACKAGES $package"
  fi
done < mypackages

# Write skipped packages to a file
if [ -n "$SKIPPED_PACKAGES" ]; then
  echo "$SKIPPED_PACKAGES" | tr ' ' '\n' | grep -v '^$' > /tmp/skipped_packages.txt
  echo "Skipped packages written to /tmp/skipped_packages.txt"
fi

# Install all available packages at once with apt-fast for parallelism
if [ -n "$AVAILABLE_PACKAGES" ]; then
  echo "Installing available packages with apt-fast..."
  sudo apt-fast install -y $AVAILABLE_PACKAGES
fi

if [ -z "$SERVER" ]; then
   echo "Checking desktop package availability from mydesktoppackages..."
   AVAILABLE_DESKTOP_PACKAGES=""
   SKIPPED_DESKTOP_PACKAGES=""
   
   while IFS= read -r package; do
     # Skip empty lines and comments
     [[ -z "$package" || "$package" =~ ^[[:space:]]*# ]] && continue
     
     # Check if package is available in apt cache
     if apt-cache show "$package" > /dev/null 2>&1; then
       AVAILABLE_DESKTOP_PACKAGES="$AVAILABLE_DESKTOP_PACKAGES $package"
     else
       echo "Warning: Package $package not found in repositories, skipping..."
       SKIPPED_DESKTOP_PACKAGES="$SKIPPED_DESKTOP_PACKAGES $package"
     fi
   done < mydesktoppackages
   
   # Write skipped desktop packages to a file
   if [ -n "$SKIPPED_DESKTOP_PACKAGES" ]; then
     echo "$SKIPPED_DESKTOP_PACKAGES" | tr ' ' '\n' | grep -v '^$' >> /tmp/skipped_packages.txt
     echo "Skipped desktop packages written to /tmp/skipped_packages.txt"
   fi
   
   # Install all available desktop packages at once with apt-fast for parallelism
   if [ -n "$AVAILABLE_DESKTOP_PACKAGES" ]; then
     echo "Installing available desktop packages with apt-fast..."
     sudo apt-fast install -y $AVAILABLE_DESKTOP_PACKAGES
   fi
#   sudo add-apt-repository -y ppa:obsproject/obs-studio
#   sudo apt-fast update
#   sudo apt-fast install -y obs-studio
fi
#virtualenv ~/beam_py3_env -p python3
#virtualenv ~/beam_py_env
#source ~/beam_py_env/bin/activate
#pip install -r beam_req.txt
#deactivate
#source ~/beam_py3_env/bin/activate
#pip install -r beam_req.txt
#deactivate
cp gitconfig ~/.gitconfig
git config --global user.email "holden@pigscanfly.ca"
git config --global user.name "Holden Karau"
set -ex
# Set up conda/mamba
export arch=$(uname -m)
if [ "$arch" == "aarm64" ]; then
  arch="arm64";
fi
# Check if conda already exists and upgrade it if present
if [ -d "/opt/conda" ] && [ -x "/opt/conda/bin/conda" ]; then
  echo "Conda already exists, upgrading..."
  sudo /opt/conda/bin/conda update -n base -c defaults conda --yes
  sudo /opt/conda/bin/conda update --all --yes
else
  echo "Installing conda..."
  wget --quiet https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-${arch}.sh -O ~/miniforge.sh
  chmod a+x ~/miniforge.sh
  sudo ~/miniforge.sh -b -p /opt/conda
  echo ". /opt/conda/etc/profile.d/conda.sh" >> ~/.bashrc
  echo ". /opt/conda/etc/profile.d/conda.sh" | sudo tee -a ~/.bashrc
  echo "conda activate base" >> ~/.bashrc
  echo "conda activate base" | sudo tee -a ~/.bashrc
fi
source ~/.bashrc
sudo /opt/conda/bin/conda clean -afy
sudo /opt/conda/bin/conda install --yes nomkl cytoolz cmake tini
sudo /opt/conda/bin/conda init bash
sudo /opt/conda/bin/conda install --yes mamba

# Install sbt
sudo apt-get update
sudo apt-get install apt-transport-https curl gnupg -yqq
echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee /etc/apt/sources.list.d/sbt_old.list
curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo -H gpg --no-default-keyring --keyring gnupg-ring:/etc/apt/trusted.gpg.d/scalasbt-release.gpg --import
sudo chmod 644 /etc/apt/trusted.gpg.d/scalasbt-release.gpg
sudo apt-get update
sudo apt-get install sbt

# Install Spark development tools
# Install available Debian packages for Spark dependencies
sudo apt-fast install -y \
    python3-ipython \
    python3-notebook \
    python3-jupyter-client \
    python3-jupyter-core \
    python3-pandas \
    python3-numpy \
    python3-matplotlib

# Install remaining Spark packages (pyspark, py4j, findspark) into conda environments
# Install in base environment
/opt/conda/bin/pip install -r spark_req.txt

# Install in each Python version environment if they exist
for env in py310 py311 py312; do
    if /opt/conda/bin/conda env list | grep -q "^${env} "; then
        /opt/conda/bin/conda run -n $env pip install -r spark_req.txt
    else
        echo "Environment $env does not exist, skipping..."
    fi
done

# Add user to docker
sudo usermod -aG docker $USER

# Install protolint
go install github.com/yoheimuta/protolint/cmd/protolint@latest
